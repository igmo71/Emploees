@page "/"
@page "/emploees-mud"
@using Emploees.Abstractions
@using Emploees.Common
@using Emploees.Components.Pages.JobTitlePages
@using Emploees.Data
@using Emploees.Domain
@using Microsoft.EntityFrameworkCore
@implements IAsyncDisposable
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Сотрудники</PageTitle>

<MudDataGrid @ref="_emploeeGrid" T="Emploee" Items="@Emploees"
			 Loading="@(Emploees is null)"
			 Bordered="true" Dense="true" Striped="true" Hover="true"
			 Filterable="true" FilterMode="DataGridFilterMode.Simple"
			 SortMode="SortMode.Single"
			 ReadOnly="@(!_isEditGrid)"
			 Groupable="true"
			 ColumnResizeMode="ResizeMode.Container"
			 EditMode="DataGridEditMode.Form"
			 EditTrigger="@DataGridEditTrigger.OnRowClick"
			 CommittedItemChanges="@CommittedItemChanges"
			 QuickFilter="QuickFilter">
	<ToolBarContent>
		<MudText Typo="Typo.h4">Сотрудники</MudText>
		<MudSpacer />
		<MudSwitch T="bool" ValueChanged="ToggleEditingGrid" Color="Color.Primary">Редактировать</MudSwitch>
		<MudFab Class="ms-5" Label="Добавить" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Disabled="@(!_isEditGrid)" OnClick="NewItemAsync" />
		<MudSpacer />
		<MudTextField @bind-Value="_searchString" Placeholder="Поиск по ФИО, Должности или Статье затрат" Adornment="Adornment.Start" Immediate="true"
					  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
		<MudSpacer />
	</ToolBarContent>
	<Columns>
		<PropertyColumn Property="x => x.Name" Title="ФИО">
			<EditTemplate>
				<MudGrid style="min-width: 500px">
					<MudItem xs="12">
						<MudTextField @bind-Value="context.Item.Name"
									  Label="Ввод ФИО"
									  Variant="Variant.Outlined"
									  Required="true"
									  RequiredError="Нужно ввести ФИО"
									  Clearable="true" />
					</MudItem>
				</MudGrid>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.JobTitle == null ? string.Empty : x.JobTitle.Name" Title="Должность">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.JobTitleId"
						   Label="Выбор Должности"
						   Required="true"
						   RequiredError="Нужно выбрать должность"
						   Variant="Variant.Outlined"
						   Clearable="true"
						   Dense="true">
					@if (JobTitles is not null)
					{
						foreach (var item in JobTitles)
						{
							<MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.CostItem == null ? string.Empty : x.CostItem.Name" Title="Статья затрат">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.CostItem"
						   T="CostItem"
						   ToStringFunc="CleanName"
						   Label="Выбор Статьи затрат"
						   Required="true"
						   RequiredError="Нужно выбрать статью затрат"
						   RelativeWidth="DropdownWidth.Ignore"
						   Variant="Variant.Outlined"
						   Clearable="true"
						   Dense="true">

					@if (CostItems is not null)
					{
						foreach (var item in CostItems)
						{
							<MudSelectItem Value="item">
								<MudText>@item.Name</MudText>
							</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Department == null ? string.Empty : x.Department.Description" Title="Отдел">
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.Department"
								 T="Catalog_СхемаПредприятия"
								 ToStringFunc="CleanDescription"
								 SearchFunc="SearchDepartment"
								 Variant="Variant.Outlined"
								 Label="Поиск Отдела (в Схеме предприятия)"
								 Required="true"
								 RequiredError="Нужно выбрать отдел"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.City == null ? string.Empty : x.City.Name" Title="Город">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.CityId"
						   Label="Выберите Город"
						   Required="true"
						   RequiredError="Нужно выбрать город"
						   Variant="Variant.Outlined"
						   Clearable="true"
						   Dense="true">
					@if (Cities is not null)
					{
						foreach (var item in Cities)
						{
							<MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Location == null ? string.Empty : x.Location.Name" Title="Локация" Required="false">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.LocationId"
						   Label="Выбор Локации"
						   Required="true"
						   RequiredError="Нужно выбрать локацию"
						   Variant="Variant.Outlined"
						   Clearable="true"
						   Dense="true">
					@if (Locations is not null)
					{
						foreach (var item in Locations)
						{
							<MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.UserUt == null ? string.Empty : x.UserUt.Description" Title="Пользователь УТ" Required="false">
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.UserUt"
								 T="Catalog_Пользователи"
								 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Description}" )"
								 SearchFunc="SearchUserUt"
								 Variant="Variant.Outlined"
								 Label="Поиск Пользователя УТ"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.EmploeeBuh == null ? string.Empty : x.EmploeeBuh.Description" Title="Сотрудник БП" Required="false">
			<CellTemplate>
				@context.Item.EmploeeBuh?.Description
				@(string.IsNullOrEmpty(context.Item.EmploeeBuh?.Code) ? string.Empty : $"({context.Item.EmploeeBuh?.Code})")
			</CellTemplate>
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.EmploeeBuh"
								 T="Catalog_Сотрудники_Buh"
								 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Description} ({e.Code})" )"
								 SearchFunc="SearchEmployeeBuh"
								 Variant="Variant.Outlined"
								 Label="Поиск Сотрудника БП"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description (@item.Code)
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.EmploeeZup == null ? string.Empty : x.EmploeeZup.Description" Title="Сотрудник ЗУП" Required="false">
			<CellTemplate>
				@context.Item.EmploeeZup?.Description
				@(string.IsNullOrEmpty(context.Item.EmploeeZup?.Code) ? string.Empty : $"({context.Item.EmploeeZup?.Code})")
			</CellTemplate>
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.EmploeeZup" FullWidth="true"
								 T="Catalog_Сотрудники_Zup"
								 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Description} ({e.Code})" )"
								 SearchFunc="SearchEmployeeZup"
								 Variant="Variant.Outlined"
								 Label="Поиск Сотрудника ЗУП"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description (@item.Code)
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.UserAd == null ? string.Empty : x.UserAd.Name" Title="AD User" Required="false">
			<CellTemplate>
				@context.Item.UserAd?.Name
			</CellTemplate>
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.UserAd" FullWidth="true"
								 T="AdUser"
								 ToStringFunc="@(e => e == null ? string.Empty :e.Name)"
								 SearchFunc="SearchUserAd"
								 Variant="Variant.Outlined"
								 Label="Поиск пользователя AD"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Name
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.OperationManager == null ? string.Empty : x.OperationManager.Name" Title="Оперативный руководитель" Required="false">

		</PropertyColumn>
		<PropertyColumn Property="x => x.LocationManager == null ? string.Empty : x.LocationManager.Name" Title="Руководитель Локации" Required="false" />
		<TemplateColumn Hidden="@(!_isEditGrid)">
			<CellTemplate>
				<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary" OnClick="@(() => DeleteItem(context.Item))" />
			</CellTemplate>
			<EditTemplate>
				<MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Small"
						   OnClick="@(() => DeleteItem(context.Item))" Class="mt-3">
					Delete
				</MudButton>
			</EditTemplate>
		</TemplateColumn>
	</Columns>
	<PagerContent>
		<MudDataGridPager T="Emploee" />
	</PagerContent>
</MudDataGrid>


@code {
	private ApplicationDbContext _context = default!;

	[PersistentState] public List<Emploee>? Emploees { get; set; }
	[PersistentState] public JobTitle[]? JobTitles { get; set; }
	[PersistentState] public City[]? Cities { get; set; }
	[PersistentState] public Location[]? Locations { get; set; }

	//[PersistentState]
	public List<CostItem>? CostItems { get; set; }
	public List<Catalog_СхемаПредприятия>? Departments { get; set; }
	public Catalog_Пользователи[]? UsersUt { get; set; }
	public Catalog_Сотрудники_Buh[]? EmploeesBuh { get; set; }
	public Catalog_Сотрудники_Zup[]? EmploeesZup { get; set; }
	public AdUser[]? UsersAd { get; set; }

	private MudDataGrid<Emploee> _emploeeGrid = default!;

	private List<string> _events = new();
	private string? _searchString;
	private bool _isEditGrid;

	protected override async Task OnInitializedAsync()
	{
		_context = DbFactory.CreateDbContext();

		Emploees ??= await LoadEmploees();
		JobTitles ??= await LoadJobTitles();
		CostItems ??= await LoadCostItems();
		Departments ??= await LoadDepartments();
		Cities ??= await LoadCities();
		Locations ??= await LoadLocations();
		UsersUt ??= await LoadUsersUt();
		EmploeesBuh ??= await LoadEmploeesBuh();
		EmploeesZup ??= await LoadEmploeesZup();
		UsersAd ??= await LoadUsersAd();
	}

	private Task<List<Emploee>> LoadEmploees()
	{
		return _context.Emploees
			.AsNoTracking()
			.Include(e => e.City)
			.Include(e => e.CostItem)
			.Include(e => e.Department)
			.Include(e => e.EmploeeBuh)
			.Include(e => e.EmploeeZup)
			.Include(e => e.JobTitle)
			.Include(e => e.Location)
			.Include(e => e.LocationManager)
			.Include(e => e.OperationManager)
			.Include(e => e.UserAd)
			.Include(e => e.UserUt)
			.ToListAsync();
	}

	private Task<JobTitle[]> LoadJobTitles() => _context.JobTitles.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private async Task<List<CostItem>> LoadCostItems()
	{
		var items = await _context.CostItems.AsNoTracking().ToListAsync();

		return TreeHelper.BuildFlattenedTree(items);
	}

	private async Task<List<Catalog_СхемаПредприятия>> LoadDepartments()
	{
		Departments = await _context.Catalog_СхемаПредприятия.AsNoTracking().ToListAsync();

		return TreeHelper.BuildFlattenedCatalogTree(Departments);
	}

	private Task<City[]> LoadCities() => _context.Cities.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private Task<Location[]> LoadLocations() => _context.Locations.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private Task<Catalog_Пользователи[]> LoadUsersUt() => _context.Catalog_Пользователи.AsNoTracking().OrderBy(e => e.Description).ToArrayAsync();

	private Task<Catalog_Сотрудники_Buh[]> LoadEmploeesBuh() => _context.Catalog_Сотрудники_Buh.AsNoTracking().OrderBy(e => e.Description).ToArrayAsync();

	private Task<Catalog_Сотрудники_Zup[]> LoadEmploeesZup() => _context.Catalog_Сотрудники_Zup.AsNoTracking().OrderBy(e => e.Description).ToArrayAsync();

	private Task<AdUser[]> LoadUsersAd() => _context.AdUsers.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private async Task NewItemAsync()
	{
		await _emploeeGrid.SetEditingItemAsync(new Emploee());
	}

	private async Task DeleteItem(Emploee item)
	{
		if (Emploees is null)
			return;

		await _context.Emploees.Where(e => e.Id == item.Id).ExecuteDeleteAsync();

		Emploees = await LoadEmploees();

		await _emploeeGrid.CancelEditingItemAsync();
	}

	private Task<IEnumerable<Catalog_СхемаПредприятия>> SearchDepartment(string value, CancellationToken token)
	{
		if (Departments is null)
			return Task.FromResult(Enumerable.Empty<Catalog_СхемаПредприятия>());

		if (string.IsNullOrEmpty(value))
			return Task.FromResult(Departments.AsEnumerable());

		return Task.FromResult(Departments
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList().AsEnumerable());
	}

	private Task<IEnumerable<Catalog_Пользователи>> SearchUserUt(string value, CancellationToken token)
	{
		if (UsersUt is null)
			return Task.FromResult(Enumerable.Empty<Catalog_Пользователи>());

		if (string.IsNullOrEmpty(value))
			return Task.FromResult(UsersUt.AsEnumerable());

		return Task.FromResult(UsersUt
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList().AsEnumerable());
	}

	private Task<IEnumerable<Catalog_Сотрудники_Buh>> SearchEmployeeBuh(string value, CancellationToken token)
	{
		if (EmploeesBuh is null)
			return Task.FromResult(Enumerable.Empty<Catalog_Сотрудники_Buh>());

		if (string.IsNullOrEmpty(value))
			return Task.FromResult(EmploeesBuh.AsEnumerable());

		return Task.FromResult(EmploeesBuh
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList().AsEnumerable());
	}

	private Task<IEnumerable<Catalog_Сотрудники_Zup>> SearchEmployeeZup(string value, CancellationToken token)
	{
		if (EmploeesZup is null)
			return Task.FromResult(Enumerable.Empty<Catalog_Сотрудники_Zup>());

		if (string.IsNullOrEmpty(value))
			return Task.FromResult(EmploeesZup.AsEnumerable());

		return Task.FromResult(EmploeesZup
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList().AsEnumerable());
	}

	private Task<IEnumerable<AdUser>> SearchUserAd(string value, CancellationToken token)
	{
		if (UsersAd is null)
			return Task.FromResult(Enumerable.Empty<AdUser>());

		if (string.IsNullOrEmpty(value))
			return Task.FromResult(UsersAd.AsEnumerable());

		return Task.FromResult(UsersAd
			.Where(x => x.Name != null && x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList().AsEnumerable());
	}

	private string CleanName<T>(T? item) where T : IHasName
	{
		if (item == null || string.IsNullOrEmpty(item.Name))
			return string.Empty;

		return item.Name.TrimStart('└', '─', '-', ' ', '\u00A0');
	}

	private string CleanDescription<T>(T? item) where T : IHasDescription
	{
		if (item == null || string.IsNullOrEmpty(item.Description))
			return string.Empty;

		return item.Description.TrimStart('└', '─', '-', ' ', '\u00A0');
	}

	private void ToggleEditingGrid(bool args)
	{
		_isEditGrid = args;
	}


	private Func<Emploee, bool> QuickFilter => e =>
	{
		if (string.IsNullOrEmpty(_searchString))
			return true;

		if (!string.IsNullOrEmpty(e.Name) && e.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (!string.IsNullOrEmpty(e.JobTitle?.Name) && e.JobTitle.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		if (!string.IsNullOrEmpty(e.CostItem?.Name) && e.CostItem.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
			return true;

		return false;
	};

	public async ValueTask DisposeAsync() => await _context.DisposeAsync();

	// events //////////////////////////////////////////

	private async Task CommittedItemChanges(Emploee item)
	{
		//_events.Insert(0, $"Event = CommittedItemChanges, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");

		if (item.Id == Guid.Empty)
		{
			var existing = new Emploee
			{
				Name = item.Name,
				CityId = item.CityId,
				CostItemId = item.CostItem?.Id,
				DepartmentId = item.Department?.Ref_Key,
				JobTitleId = item.JobTitleId

			};
			await _context.Emploees.AddAsync(existing);
		}
		else
		{
			var existing = _context.Emploees.FirstOrDefault(e => e.Id == item.Id);

			if (existing is null)
				return;

			_context.Entry<Emploee>(existing).CurrentValues.SetValues(item);

			existing.CostItemId = item.CostItem is null ? null : item.CostItem.Id;

			existing.DepartmentId = item.Department is null ? null : item.Department?.Ref_Key;

			existing.UserUtId = item.UserUt is null ? null : item.UserUt.Ref_Key;

			existing.EmploeeBuhId = item.EmploeeBuh is null ? null : item.EmploeeBuh.Ref_Key;

			existing.EmploeeZupId = item.EmploeeZup is null ? null : item.EmploeeZup.Ref_Key;

			existing.UserAdId = item.UserAd is null ? null : item.UserAd.Sid;
		}
		await _context.SaveChangesAsync();

		Emploees = await LoadEmploees();
	}

	// private void StartedEditingItem(Emploee item)
	// {
	// 	_events.Insert(0, $"Event = StartedEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
	// }

	// private void CanceledEditingItem(Emploee item)
	// {
	// 	_events.Insert(0, $"Event = CanceledEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
	// }

	// private void SelectedItemChanged(Emploee item)
	// {
	// 	_events.Insert(0, $"Event = SelectedItemChanged, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
	// }

	// private void SelectedItemsChanged(HashSet<Emploee> items)
	// {
	// 	_events.Insert(0, $"Event = SelectedItemsChanged, Data = {System.Text.Json.JsonSerializer.Serialize(items)}");
	// }
}
