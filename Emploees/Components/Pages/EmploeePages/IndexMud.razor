@page "/"
@page "/emploees-mud"
@using Emploees.Abstractions
@using Emploees.Common
@using Emploees.Components.Pages.JobTitlePages
@using Emploees.Data
@using Emploees.Domain
@using Microsoft.EntityFrameworkCore
@implements IAsyncDisposable
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>Сотрудники</PageTitle>

<MudDataGrid @ref="_emploeeGrid" T="Emploee" Items="@Emploees"
			 Loading="@(Emploees is null)"
			 Bordered="true" Dense="true" Striped="true" Hover="true"
			 Filterable="true" FilterMode="DataGridFilterMode.Simple"
			 SortMode="SortMode.Single"
			 ReadOnly="@(!_isEditGrid)"
			 Groupable="true"
			 ColumnResizeMode="ResizeMode.Container"
			 EditMode="DataGridEditMode.Form"
			 EditTrigger="@DataGridEditTrigger.OnRowClick"
			 StartedEditingItem="@StartedEditingItem"
			 CanceledEditingItem="@CanceledEditingItem"
			 CommittedItemChanges="@CommittedItemChanges"
			 SelectedItemChanged="SelectedItemChanged"
			 SelectedItemsChanged="SelectedItemsChanged">
	<ToolBarContent>
		<MudText Typo="Typo.h4" Class="me-5">Сотрудники</MudText>
		<MudSwitch Class="me-5" T="bool" ValueChanged="ToggleEditingGrid" Color="Color.Primary">Редактировать</MudSwitch>
		<MudFab Label="Добавить" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Disabled="@(!_isEditGrid)" OnClick="NewItemAsync" />
	</ToolBarContent>
	<Columns>
		<PropertyColumn Property="x => x.Name" Title="ФИО">
			<EditTemplate>
				<MudGrid style="min-width: 500px">
					<MudItem xs="12">
						<MudTextField @bind-Value="context.Item.Name" Label="ФИО" Variant="Variant.Outlined" />
					</MudItem>
				</MudGrid>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.JobTitle == null ? string.Empty : x.JobTitle.Name" Title="Должность">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.JobTitleId" Label="Должность" Required="true" RequiredError="Нужно выбрать должность"
						   Variant="Variant.Outlined">
					@if (JobTitles is not null)
					{
						foreach (var item in JobTitles)
						{
							<MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.CostItem == null ? string.Empty : x.CostItem.Name" Title="Статья затрат">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.CostItem"
						   T="CostItem"
						   ToStringFunc="CleanName"
						   Label="Статья затрат"
						   Required="true"
						   RequiredError="Нужно выбрать статью затрат"
						   Dense="true"
						   RelativeWidth="DropdownWidth.Ignore"
						   Variant="Variant.Outlined">

					@if (CostItems is not null)
					{
						foreach (var item in CostItems)
						{
							<MudSelectItem Value="item">
								<MudText>@item.Name</MudText>
							</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Department == null ? string.Empty : x.Department.Description" Title="Отдел">
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.Department"
								 T="Catalog_СхемаПредприятия"
								 ToStringFunc="CleanDescription"
								 SearchFunc="SearchDepartment"
								 Variant="Variant.Outlined"
								 Label="Отдел"
								 Required="true"
								 RequiredError="Нужно выбрать отдел"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.City == null ? string.Empty : x.City.Name" Title="Город">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.CityId" Label="Город" Required="true" RequiredError="Нужно выбрать город" Variant="Variant.Outlined">
					@if (Cities is not null)
					{
						foreach (var item in Cities)
						{
							<MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.Location == null ? string.Empty : x.Location.Name" Title="Локация" Required="false">
			<EditTemplate>
				<MudSelect @bind-Value="context.Item.LocationId" Label="Локация" Required="true" RequiredError="Нужно выбрать локацию" Variant="Variant.Outlined">
					@if (Locations is not null)
					{
						foreach (var item in Locations)
						{
							<MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
						}
					}
				</MudSelect>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.UserUt == null ? string.Empty : x.UserUt.Description" Title="Пользователь УТ" Required="false">
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.UserUt"
								 T="Catalog_Пользователи"
								 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Description}" )"
								 SearchFunc="SearchUserUt"
								 Variant="Variant.Outlined"
								 Label="Пользователь УТ"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.EmploeeBuh == null ? string.Empty : x.EmploeeBuh.Description" Title="Сотрудник БП" Required="false">
			<CellTemplate>
				@context.Item.EmploeeBuh?.Description (@context.Item.EmploeeBuh?.Code)
			</CellTemplate>
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.EmploeeBuh"
								 T="Catalog_Сотрудники_Buh"
								 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Description} ({e.Code})" )"
								 SearchFunc="SearchEmployeeBuh"
								 Variant="Variant.Outlined"
								 Label="Сотрудник БП"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description (@item.Code)
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.EmploeeZup == null ? string.Empty : x.EmploeeZup.Description" Title="Сотрудник ЗУП" Required="false">
			<CellTemplate>
				@context.Item.EmploeeZup?.Description
				@if (string.IsNullOrEmpty(context.Item.EmploeeZup?.Code))
				{
					@string.Empty
				}
				else
				{
					@($"({context.Item.EmploeeZup?.Code})")
				}
			</CellTemplate>
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.EmploeeZup" FullWidth="true"
								 T="Catalog_Сотрудники_Zup"
								 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Description} ({e.Code})" )"
								 SearchFunc="SearchEmployeeZup"
								 Variant="Variant.Outlined"
								 Label="Сотрудник ЗУП"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Description (@item.Code)
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.UserAd == null ? string.Empty : x.UserAd.Name" Title="AD User" Required="false">
			<CellTemplate>
				@context.Item.UserAd?.Name
			</CellTemplate>
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.UserAd" FullWidth="true"
								 T="AdUser"
								 ToStringFunc="@(e => e == null ? string.Empty :e.Name)"
								 SearchFunc="SearchUserAd"
								 Variant="Variant.Outlined"
								 Label="User AD"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Name
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn>
		<PropertyColumn Property="x => x.OperationManager == null ? string.Empty : x.OperationManager.Name" Title="Оперативный руководитель" Required="false" />
		<PropertyColumn Property="x => x.LocationManager == null ? string.Empty : x.LocationManager.Name" Title="Руководитель Локации" Required="false" />
		<TemplateColumn Hidden="@(!_isEditGrid)">
			<CellTemplate>
				<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary" OnClick="@(() => DeleteItem(context.Item))" />
			</CellTemplate>
			<EditTemplate>
				<MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Small"
						   OnClick="@(() => DeleteItem(context.Item))" Class="mt-3">
					Delete
				</MudButton>
			</EditTemplate>
		</TemplateColumn>
	</Columns>
	<PagerContent>
		<MudDataGridPager T="Emploee" />
	</PagerContent>
</MudDataGrid>


@code {
	private ApplicationDbContext _context = default!;

	[PersistentState] public List<Emploee>? Emploees { get; set; }
	[PersistentState] public JobTitle[]? JobTitles { get; set; }
	[PersistentState] public List<CostItem>? CostItems { get; set; }
	[PersistentState] public List<Catalog_СхемаПредприятия>? Departments { get; set; }
	[PersistentState] public City[]? Cities { get; set; }
	[PersistentState] public Location[]? Locations { get; set; }
	[PersistentState] public Catalog_Пользователи[]? UsersUt { get; set; }
	[PersistentState] public Catalog_Сотрудники_Buh[]? EmploeesBuh { get; set; }
	[PersistentState] public Catalog_Сотрудники_Zup[]? EmploeesZup { get; set; }
	[PersistentState] public AdUser[]? UsersAd { get; set; }


	private MudDataGrid<Emploee> _emploeeGrid = default!;

	private List<string> _events = new();
	private bool _isEditGrid;

	protected override async Task OnInitializedAsync()
	{
		_context = DbFactory.CreateDbContext();

		Emploees ??= await LoadEmploees();
		JobTitles ??= await LoadJobTitles();
		CostItems ??= await LoadCostItems();
		Departments ??= await LoadDepartments();
		Cities ??= await LoadCities();
		Locations ??= await LoadLocations();
		UsersUt ??= await LoadUsersUt();
		EmploeesBuh ??= await LoadEmploeesBuh();
		EmploeesZup ??= await LoadEmploeesZup();
		UsersAd ??= await LoadUsersAd();
	}

	private Task<List<Emploee>> LoadEmploees()
	{
		return _context.Emploees
			.AsNoTracking()
			.Include(e => e.City)
			.Include(e => e.CostItem)
			.Include(e => e.Department)
			.Include(e => e.EmploeeBuh)
			.Include(e => e.EmploeeZup)
			.Include(e => e.JobTitle)
			.Include(e => e.Location)
			.Include(e => e.LocationManager)
			.Include(e => e.OperationManager)
			.Include(e => e.UserAd)
			.Include(e => e.UserUt)
			.ToListAsync();
	}

	private Task<JobTitle[]> LoadJobTitles() => _context.JobTitles.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private async Task<List<CostItem>> LoadCostItems()
	{
		var items = await _context.CostItems.AsNoTracking().ToListAsync();

		return TreeHelper.BuildFlattenedTree(items);
	}

	private async Task<List<Catalog_СхемаПредприятия>> LoadDepartments()
	{
		Departments = await _context.Catalog_СхемаПредприятия.AsNoTracking().ToListAsync();

		return TreeHelper.BuildFlattenedCatalogTree(Departments);
	}

	private Task<City[]> LoadCities() => _context.Cities.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private Task<Location[]> LoadLocations() => _context.Locations.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private Task<Catalog_Пользователи[]> LoadUsersUt() => _context.Catalog_Пользователи.AsNoTracking().OrderBy(e => e.Description).ToArrayAsync();

	private Task<Catalog_Сотрудники_Buh[]> LoadEmploeesBuh() => _context.Catalog_Сотрудники_Buh.AsNoTracking().OrderBy(e => e.Description).ToArrayAsync();

	private Task<Catalog_Сотрудники_Zup[]> LoadEmploeesZup() => _context.Catalog_Сотрудники_Zup.AsNoTracking().OrderBy(e => e.Description).ToArrayAsync();

	private Task<AdUser[]> LoadUsersAd() => _context.AdUsers.AsNoTracking().OrderBy(e => e.Name).ToArrayAsync();

	private async Task NewItemAsync()
	{
		await _emploeeGrid.SetEditingItemAsync(new Emploee());
	}

	private async Task DeleteItem(Emploee item)
	{
		if (Emploees is null)
			return;

		await _context.Emploees.Where(e => e.Id == item.Id).ExecuteDeleteAsync();

		await _emploeeGrid.CancelEditingItemAsync();
	}

	private async Task<IEnumerable<Catalog_СхемаПредприятия>> SearchDepartment(string value, CancellationToken token)
	{
		if (Departments is null)
			return [];

		if (string.IsNullOrEmpty(value))
			return Departments;

		var result = Departments
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList();

		return result;
	}

	private async Task<IEnumerable<Catalog_Пользователи>> SearchUserUt(string value, CancellationToken token)
	{
		if (UsersUt is null)
			return [];

		if (string.IsNullOrEmpty(value))
			return UsersUt;

		var result = UsersUt
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList();

		return result;
	}

	private async Task<IEnumerable<Catalog_Сотрудники_Buh>> SearchEmployeeBuh(string value, CancellationToken token)
	{
		if (EmploeesBuh is null)
			return [];

		if (string.IsNullOrEmpty(value))
			return EmploeesBuh;

		var result = EmploeesBuh
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList();

		return result;
	}

	private async Task<IEnumerable<Catalog_Сотрудники_Zup>> SearchEmployeeZup(string value, CancellationToken token)
	{
		if (EmploeesZup is null)
			return [];

		if (string.IsNullOrEmpty(value))
			return EmploeesZup;

		var result = EmploeesZup
			.Where(x => x.Description != null && x.Description.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList();

		return result;
	}



	private async Task<IEnumerable<AdUser>> SearchUserAd(string value, CancellationToken token)
	{
		if (UsersAd is null)
			return [];

		if (string.IsNullOrEmpty(value))
			return UsersAd;

		var result = UsersAd
			.Where(x => x.Name != null && x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.ToList();

		return result;
	}

	private string CleanName<T>(T? item) where T : IHasName
	{
		if (item == null || string.IsNullOrEmpty(item.Name))
			return string.Empty;

		return item.Name.TrimStart('└', '─', '-', ' ', '\u00A0');
	}

	private string CleanDescription<T>(T? item) where T : IHasDescription
	{
		if (item == null || string.IsNullOrEmpty(item.Description))
			return string.Empty;

		return item.Description.TrimStart('└', '─', '-', ' ', '\u00A0');
	}

	private void ToggleEditingGrid(bool args)
	{
		_isEditGrid = !_isEditGrid;
	}

	public async ValueTask DisposeAsync() => await _context.DisposeAsync();

	// events //////////////////////////////////////////

	private async Task CommittedItemChanges(Emploee item)
	{
		_events.Insert(0, $"Event = CommittedItemChanges, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");

		if (item.Id == Guid.Empty)
		{
			var existing = new Emploee
			{
				Name = item.Name,
				CityId = item.CityId,
				CostItemId = item.CostItem?.Id,
				DepartmentId = item.Department?.Ref_Key,
				JobTitleId = item.JobTitleId

			};
			await _context.Emploees.AddAsync(existing);
		}
		else
		{
			var existing = _context.Emploees.FirstOrDefault(e => e.Id == item.Id);

			if (existing is null)
				return;

			_context.Entry<Emploee>(existing).CurrentValues.SetValues(item);

			if (item.CostItem is not null)
				existing.CostItemId = item.CostItem.Id;

			if (item.Department is not null)
				existing.DepartmentId = item.Department.Ref_Key;

			if (item.UserUt is not null)
				existing.UserUtId = item.UserUt.Ref_Key;

			if (item.EmploeeBuh is not null)
				existing.EmploeeBuhId = item.EmploeeBuh.Ref_Key;

			if (item.EmploeeZup is not null)
				existing.EmploeeZupId = item.EmploeeZup.Ref_Key;
		}
		await _context.SaveChangesAsync();

		Emploees = await LoadEmploees();
	}

	private void StartedEditingItem(Emploee item)
	{
		_events.Insert(0, $"Event = StartedEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
	}

	private void CanceledEditingItem(Emploee item)
	{
		// update code for backing data here if needed
		_events.Insert(0, $"Event = CanceledEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
	}

	private void SelectedItemChanged(Emploee item)
	{
		_events.Insert(0, $"Event = SelectedItemChanged, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
	}

	private void SelectedItemsChanged(HashSet<Emploee> items)
	{
		_events.Insert(0, $"Event = SelectedItemsChanged, Data = {System.Text.Json.JsonSerializer.Serialize(items)}");
	}
}
